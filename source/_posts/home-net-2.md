---
title: 家庭网络的升级之旅(二)
date: 2021-01-19 13:54:59
top:
categories:
- 一起哈啤
tags:
- v2ray
- vpn
- 科学上网
---

你问我(一)在哪里？其实并没有写，因为我懒。。。。。(小声bb)

那么(一)是什么呢，简单来说就是加了个软路由 `r2s`，用 `主路由` 的模式实现了路由翻墙～

### 升级之旅(一)

#### 痛点

- 每个设备出国留学都要开相应的软件：`Windows` -> `v2rayN`，`Mac` -> `v2rayU`，`ios` -> `shadowRocket`
- PC上代理游戏流量还得单独开 `proxifier` 软件，参考之前写的一片文章 [ss + proxifier 实现vpn游戏代理](https://jian2333.github.io/2019/09/10/sstovpn/)
- `switch` 联网得通过共享 `wifi` 的方式，一直开着 `PC` 或者 `iphone`

种种的不便大大降低了用户体验，尤其是玩 `switch` 的时候，每次都要特意开 `PC` 或 `iphone` 挂着，实在是不方便了～

那么，有什么方法能一起解决上面的问题呢？

<!--more-->

#### 解决方案

答案，当然是有的，**路由翻墙**就是很好的一种方案！

- 路由器翻墙后，连接路由器的所有设备(有线/无线)都会根据**流量规则**自行决定是否翻墙
- 在 `路由翻墙插件` 里，设置 `协议规则`：
  - `TCP`: 使用 `v2ray` 协议，上网速度快；
  - `UDP`: 使用 `ss` 协议，玩游戏稳定(上网速度慢)

**Tips**：之所以 `UDP` 使用 `ss` 而不使用 `v2ray`，因为 `v2ray` 不适合作为**游戏的流量协议**，`v2ray` 进行了多次流量转换，网络类型很差，比如在 `switch` 里：

- `UDP` 使用 `ss` 时：`NAT` 类型为**A**，网络质量最好
- `UDP` 使用 `v2ray` 时：`NAT` 类型为**D**，网络质量非常差，基本不能联机

Ok，理论方案已经确定，接下来就是实践开始～

##### 硬路由尝试

最开始是直接尝试用硬路由刷 `梅林固件`、`老毛子固件` 等，但硬路由配置太低，刷了系统后跑不起来，最后决定**直 接 上 软路由！！**

##### 软路由

软路由选择了入门级的 `r2s` ，因为性价比极高，只要200块就行，性能也够，而且体积非常小，很方便～

然后就是常规操作了，刷固件，配置 `passwall`，选择代理模式：

- `TCP`: `v2ray` 协议，默认模式为 `中国大陆以外`
- `UDP`: `ss` 协议，默认模式为 `游戏模式`

家庭网络采用 `主路由` 的连接方式：

- `光猫` -> `软路由` -> `硬路由`(作为**路由器**) -> `多个设备ABCDE`
- `软路由` 中使用 `passwall` 插件进行**路由翻墙**
- `硬路由` 中进行 `IP` 与 `MAC` 绑定，`wifi` 发射，`多个设备ABCDE` 的 `连接限制`、`网络限制`等功能

<img src="/images/hn-before.png" alt="家庭网络前" style="zoom:40%;" />

到此为止，之前的需求都满足了，完美！

### 升级之旅(二)

之后的时间一直都运行完美，直到入手了 `喷喷(喷射战士2)`....

#### 新的痛点

之前有说过，网页都走 `TCP` 的 `v2ray` 协议，网速快，游戏**都**走 `UDP` 的 `ss` 协议，网络稳定。

但是，`喷喷` 是个特例..... 这游戏会**同时**走 `TCP` 和 `UDP` 协议，而且对网络要求极高，`NAT` 必须是 `B` 以上。换句话说就是，玩 `喷喷` 的时候，**`TCP` 也要设置成 `ss` 协议**。。。。

那么，新问题来了，玩 `喷喷` 的时候设置成 `ss` 协议，玩完后改回 `v2ray` 协议？

不行～～ 这样太麻烦了.....

所以...有方法能解决上面的问题吗？🤔️

#### 方案

经过大量的查阅资料，发现了一种可行的方案：

- `passwall` 里设置2个 `TCP` 协议，分别是 `TCP1` -> `v2ray` 和 `TCP2` -> `ss`
- 默认设置为 `TCP1`
- **重点**： 在 `访问控制` 里，通过 `IP` 或 `MAC` 匹配到 `switch`，然后设置为 `TCP2` 

按理来说这样应该就可行了。但是，新的问题又出现了，当前 `主路由` 模式下，`软路由` 只能获取 `硬路由` 的 `IP` 和 `MAC`， 而 `设备ABCDE` 的 `IP` 和 `MAC` 又只能在 `硬路由` 中获取，而且 `软路由r2s` 只有一个 `LAN` 口，不能同时接多个 `设备ABCDE`。也就是说，`r2s` 不能识别到 `switch`，进而不能用 `访问控制` 来设置为 `TCP2` 了...

然后我又想到了**交换机**的 `中继AP` 模式，正好完美解决当前的问题了.....

其实就是把之前 `主路由` 模式下的 `硬路由`，从 `路由器` 改为 `交换机` 的功能，这样 `硬路由` 就相当于一个 `hub` 类似的功能，不提供实际 `IP` 和 `MAC`，只提供**分流**功能，把 `软路由` `LAN` 出来的流量直接给对应的 `设备ABCDE`，而且这种情况下，`软路由` 可以直接获取到 `设备ABCDE` 的 `IP` 和 `MAC`，进而就能通过 `访问控制` 设置 `switch` 的 `TCP` 了

**新的家庭网络连接方式**

<img src="/images/hn-after.png" alt="8txA7M_20210120171154" style="zoom:40%;" />

**passwall相关配置**

<img src="/images/hn-1.jpeg" alt="IP与Mac绑定" style="zoom:30%;" />

<img src="/images/hn-2.jpeg" alt="passwall 默认协议" style="zoom:33%;" />

<img src="/images/hn-3.jpeg" alt="passwall 默认代理模式" style="zoom:37%;" />

![访问控制](/images/hn-4.jpeg)

这样配置后，上面的问题就完美解决啦～

#### 剩余问题

理论上讲，上面的方案配置正确的话，应该是可行的。

但实际发现，`访问控制` 这个功能并没有生效。~~网上查找资料后发现，貌似是新版本 `passwall` 有这个问题，旧版本就没有....~~

然后吧...给作者提了个 [issue](https://github.com/xiaorouji/openwrt-passwall/issues/887) ，等待大佬的修复.....

**2021.01.24  更新**

作者回复了，备注里不能有空格....

然后试了下，果然就可以了......之前还升级 `固件`、`passwall` 版本折腾了好久。。。。

另外再吐槽下，`switch` 的 `wifi` 性能**真是辣鸡!!**，时不时的来一次掉线.....

最后还是买了 `usb网络交换器` 有线连 `switch` ...

PS：注意同时兼容 `有线模式` 和 `无线模式` ～～

![访问控制](/images/hn-5.jpeg)

### 最终成果

经过这次升级后，家里的网络更加智能啦～

可以根据规则指定 `某些设备` 走 `指定的协议`，而不会对主网络(默认 `v2ray` 的 `TCP` 协议)有影响。比如 `switch` ， 可以指定全程走 `ss` 协议，然后

就可以愉快的 `喷喷` 啦～ 😊

![splatoon_2 喷喷](/images/hn-splatoon.jpg)



